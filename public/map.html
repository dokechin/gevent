<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<title>ゲリライベント共有サイト</title>
<style type="text/css"> 
  html {height: 100%;}
  body {height: 100%; margin: 0; padding: 0; background-color: #000; font-size: small; font-family: Arial, "メイリオ", "Hiragino Kaku Gothic Pro", "ヒラギノ角ゴ Pro W4", "Osaka", "MS PGothic", sans-serif;}
  #header {position: absolute; top: 0; left: 0; overflow: hidden; padding: 5px 5px; color: #FFF;}
  #header a {color: #FFF; text-decoration: underline;}
  #map_canvas {position: absolute; top: 35px; left: 0; right: 205px; bottom: 0; width: auto; height: auto; overflow: hidden;}
  #side_bar {position: absolute; top: 35px; right: 0; bottom: 0; width: 190px; height: auto; overflow: auto; padding: 5px 5px; background-color: #eaeaea; line-height: 1.8;}
</style>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="./js/util.js"></script>
<script type="text/javascript"> 
var icon = Array();
    icon[0] = "./img/tissue.png";
    icon[1] = "./img/sale.png";
    icon[2] = "./img/live.png";
    icon[3] = "./img/sample.png";
var event_name = Array();
    event_name[0] = "ティシュ配布";
    event_name[1] = "タイムセール";
    event_name[2] = "路上ライブ";
    event_name[3] = "サンプル配布";

var infowindow = new google.maps.InfoWindow();
var map;
var geocoder;
var markers = [];
var marcador = new google.maps.Marker();
function load() {
  geocoder = new google.maps.Geocoder();
  var latLng = new google.maps.LatLng(35.68923, 139.752274);
  var myOptions = {
    zoom: 8,
    center: latLng,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    mapTypeControl: true,
    mapTypeControlOptions: {
      style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
    },
    panControl: false,
    scaleControl: false,
    zoomControl: true,
    zoomControlOptions: {
      style: google.maps.ZoomControlStyle.SMALL,
      position: google.maps.ControlPosition.LEFT_TOP
    }
  }
  map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

  google.maps.event.addListener(map, 'click', function(event) {
    placeMarker(event.latLng);
  });

}

function placeMarker(location) {
  var marker = new google.maps.Marker({
      position: location,
      map: map
  });

  var infoWindowContent = [
    "<b>Get Directions From...</b><br />",
    "<form id='map-form'>",
    "Address/Postcode: <input id='map-from-address' type='text' />",
    "<input type='submit' id='map-go' value='Go' />",
    "</form>"
  ].join("");

//  marker.mylabel = label;
// marker.mycategory = category;
  google.maps.event.addListener(marker, "click", function() {
    if (infowindow) infowindow.close();
    infowindow = new google.maps.InfoWindow({content: infoWindowContent});
    infowindow.open(map, marker);
  });

  google.maps.event.addListener(info, 'domready', function() {
    document.id("map-form").addEvent("submit", function(e) {
        e.stop();
        alert("hi");
    });
  });

  map.setCenter(location);
}

function searchLocations() {
  infowindow.close();
  for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(null);
  }
  markers.length = 0;
  marcador.setMap(null);
  var address = document.getElementById("addressInput").value;
  geocoder.geocode({"address": address}, function(results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      marcador = new google.maps.Marker({map: map, title: "目標", position: results[0].geometry.location});
      searchLocationsNear(results[0].geometry.location);
    } else {alert("Geocode was not successful for the following reason: " + status);}
  });
}
function searchLocationsNear(center) {
  var radius = document.getElementById("radiusSelect").value;

  var searchUrl = "./search?lat="+center.lat()+"&lng="+center.lng()+"&radius="+radius;
  downloadUrl(searchUrl, function(data) {
    var markers = data.documentElement.getElementsByTagName("marker");
    var sidebar = document.getElementById("side_bar");

    sidebar.innerHTML = "";
    if (markers.length == 0) {
      sidebar.innerHTML = 'データベース内にイベントがありません';
      map.setCenter(new google.maps.LatLng(35.690921,139.700258), 8);
      return;
    }
    var bounds = new google.maps.LatLngBounds();
    for (var i = 0; i < markers.length; i++) {
      var latlng = new google.maps.LatLng(parseFloat(markers[i].getAttribute("lat")), parseFloat(markers[i].getAttribute("lng")));
      var label = markers[i].getAttribute("name");
      var n = markers[i].getAttribute("type");
      var ename = markers[i].getAttribute("detail");
      var category = event_name[n];
      var distance = markers[i].getAttribute("distance");
      var marker = createMarker(latlng, label, category, n, ename, distance);
      bounds.extend(latlng);
    }
    map.fitBounds(bounds);
  });
}
function createMarker(latlng, label, category, n, ename, distance) {
  var icoimg = new google.maps.MarkerImage(icon[n],
    new google.maps.Size(48, 48),
    new google.maps.Point(0, 0),
    new google.maps.Point(10, 10)
  );
  var marker = new google.maps.Marker({position: latlng, map: map, title: label, icon: icoimg});
  var html = "<b>"+label+"<\/b><br/>"+ename+"<br/>"+category+"<br/>（目的地から "+distance+" km）";
  marker.mylabel = label;
  marker.mycategory = category;
  google.maps.event.addListener(marker, "click", function() {
    if (infowindow) infowindow.close();
    infowindow = new google.maps.InfoWindow({content: html});
    infowindow.open(map, marker);
  });
  markers.push(marker);
  createSidebarEntry();
}
function myclick(i) {
  google.maps.event.trigger(markers[i], "click");
}
function createSidebarEntry() {
  var html = "";
  for (var i=0; i<markers.length; i++) {
    if (markers[i].getVisible()) {
      html += '<a href="javascript:myclick('+i+')">'+markers[i].mylabel+'<\/a>（'+markers[i].mycategory+'）<br>';
    }
  }
  document.getElementById("side_bar").innerHTML = html;
}
google.maps.event.addDomListener(window, "load", load);
</script>
</head>
<body>
<div id="header">
  <form action="#" onsubmit="searchLocations(); return false">
    ［住所・地名など］<input type="text" size="20" id="addressInput" value="新宿駅" />から半径
    <select id="radiusSelect">
      <option value="1" selected>1km</option>
      <option value="5">5km</option>
      <option value="10">10km</option>
    </select>
    <input type="button" onclick="searchLocations()" value="以内のイベントを検索" />
  </form>
</div>
<div id="side_bar">
  首都圏1500駅から検索<br />
  東京メトロ、都営地下鉄、JR、東急、小田急、京王、東武、西武、京急、京成、相鉄など<br />
  検索結果は最大20件まで表示します
</div>
<div id="map_canvas"></div>
</body>
</html>
